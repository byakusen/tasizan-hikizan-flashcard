<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>たし算＋ひき算ミックス｜OK/NGでNGのみ再出題</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827ee; --card:#111827;
      --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8;
      --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, #1e293b 0%, var(--bg) 60%);
      color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .app{width:min(1180px, 100%);}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:12px}
    header h1{font-size:20px; font-weight:700; margin:0; letter-spacing:.02em}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .group{background:var(--panel); border:1px solid #1f2937; padding:10px 12px; border-radius:14px; display:flex; align-items:center; gap:10px}
    .seg{display:flex; gap:6px; flex-wrap:wrap}
    .seg button{padding:8px 10px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--text); cursor:pointer}
    .seg button[data-active="true"]{border-color:var(--accent); box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 40%, transparent);}
    button.primary{background: linear-gradient(180deg, #38bdf8, #0284c7); color:black; border:none}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid #374151; background:#0b1220; color:var(--text); cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.good{background:linear-gradient(180deg, #22c55e, #15803d); border:none; color:#062b18}
    .btn.bad{background:linear-gradient(180deg, #ef4444, #b91c1c); border:none; color:#2b0a0a}
    .btn.warn{background:linear-gradient(180deg, #f59e0b, #b45309); border:none; color:#1a0e00}

    .board{
      display:grid; grid-template-columns: 1fr 420px; gap:18px; align-items:stretch; margin-top:12px
    }
    @media (max-width: 900px){ .board{grid-template-columns: 1fr} }

    .card{
      background: linear-gradient(180deg, #0b1220, #0a0f1a);
      border:1px solid #1f2937; border-radius:var(--radius); padding:24px; box-shadow:var(--shadow);
      position:relative; display:flex; align-items:center; justify-content:center; min-height:320px;
      perspective: 1000px;
      font-size: clamp(36px, 7vw, 72px);
    }

    .panel{
      background:var(--panel); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0}

    .progress{height:10px; background:#0b1220; border:1px solid #1f2937; border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #22d3ee)}

    .stat{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px}
    .pill{border:1px solid #374151; background:#0b1220; padding:10px 12px; border-radius:12px; text-align:center}
    .pill strong{display:block; font-size:18px}

    .note{color:var(--muted); font-size:13px}
    .kbd{border:1px solid #374151; background:#0b1220; padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .footer{margin-top:16px; color:var(--muted); font-size:13px; text-align:center}
    a.link{color:var(--accent); text-decoration:none}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>たし算＋ひき算ミックス</h1>
      <div class="controls">
        <div class="group">
          <label><input type="checkbox" id="useAdd" checked> たし算</label>
          <label><input type="checkbox" id="useSub" checked> ひき算</label>
        </div>
        <div class="group" id="addGroup">
          <span class="note" style="margin:0 6px 0 2px">たし算：a+◯</span>
          <div class="seg" id="addSeg"></div>
          <button class="btn warn" id="addAll">全部</button>
          <button class="btn" id="addClear">クリア</button>
          <label style="margin-left:6px"><input type="checkbox" id="carryB"> くり上がり（答え2けたのみ）</label>
        </div>
        <div class="group" id="subGroup">
          <span class="note" style="margin:0 6px 0 2px">ひき算：◯−b</span>
          <div class="seg" id="subSeg"></div>
          <button class="btn warn" id="subAll">全部</button>
          <button class="btn" id="subClear">クリア</button>
          <label style="margin-left:6px"><input type="checkbox" id="borrowB"> くり下がり（被減数2けたのみ）</label>
        </div>
        <div class="group">
          <label><input type="checkbox" id="shuffleB" checked> シャッフル</label>
        </div>
        <button class="btn primary" id="startBtn">スタート / リセット</button>
      </div>
    </header>

    <div class="board">
      <section class="card" id="card" aria-live="polite">出題をスタートしてください</section>

      <aside class="panel">
        <div class="row"><strong>進捗</strong> <span id="count">0 / 0</span></div>
        <div class="progress" aria-label="Progress"><div class="bar" id="bar"></div></div>
        <div class="stat">
          <div class="pill"><span>OK</span><strong id="okC">0</strong></div>
          <div class="pill"><span>NG</span><strong id="ngC">0</strong></div>
        </div>

        <div class="row"><strong>タイマー</strong> <span id="timer">00:00.0</span></div>
        <div class="row">
          <button class="btn" id="timerToggle" disabled>一時停止</button>
          <span class="note">スタートで自動開始 / 完了で自動停止</span>
        </div>

        <div class="row" style="gap:10px; flex-wrap:wrap; justify-content:center">
          <button class="btn" id="revealBtn" disabled>答えを表示 <span class="kbd">Space</span></button>
          <button class="btn good" id="okBtn" disabled>OK <span class="kbd">O</span></button>
          <button class="btn bad" id="ngBtn" disabled>NG <span class="kbd">X</span></button>
        </div>
        <div class="row">
          <button class="btn" id="redoBtn" disabled>やり直す（最初から）</button>
        </div>
        <p class="note">ラウンド終了ごとに <strong>NGだけ</strong>を自動で再出題します。すべてOKになるまで繰り返します。</p>
        <p class="note">キーボード: <span class="kbd">Space</span> = 表示, <span class="kbd">O</span> = OK, <span class="kbd">X</span> = NG</p>
      </aside>
    </div>

    <div class="footer">© たし算＋ひき算ミックス / ローカル動作・データはブラウザ内のみ</div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const shuffle = arr => arr.sort(()=>Math.random()-0.5);

  // --- Timer ---
  let t0 = 0, elapsed = 0, ticker = null, running = false;
  function fmt(ms){
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const ss = s%60;
    const ds = Math.floor((ms%1000)/100);
    return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}.${ds}`;
  }
  function updateTimerUI(){ $('#timer').textContent = fmt(elapsed); $('#timerToggle').textContent = running? '一時停止' : '再開'; }
  function startTimer(){ if(running) return; running = true; t0 = performance.now() - elapsed; ticker = setInterval(()=>{ elapsed = performance.now()-t0; updateTimerUI(); }, 100); $('#timerToggle').disabled = false; }
  function stopTimer(){ if(!running) return; running = false; clearInterval(ticker); ticker = null; updateTimerUI(); }
  function resetTimer(){ stopTimer(); elapsed = 0; updateTimerUI(); }

  // --- Build selectable buttons ---
  // たし算 a+◯ (a=1..9)
  const addSeg = $('#addSeg');
  for(let a=1; a<=9; a++){
    const b = document.createElement('button');
    b.textContent = `${a}+◯`;
    b.setAttribute('data-a', a);
    b.setAttribute('data-active', 'true');
    b.addEventListener('click', ()=>{
      const on = b.getAttribute('data-active') === 'true';
      b.setAttribute('data-active', String(!on));
    });
    addSeg.appendChild(b);
  }
  $('#addAll').addEventListener('click', ()=> $$('#addSeg button').forEach(b=>b.setAttribute('data-active','true')));
  $('#addClear').addEventListener('click', ()=> $$('#addSeg button').forEach(b=>b.setAttribute('data-active','false')));

  // ひき算 ◯−b (b=1..9)
  const subSeg = $('#subSeg');
  for(let b=1; b<=9; b++){
    const btn = document.createElement('button');
    btn.textContent = `◯−${b}`;
    btn.setAttribute('data-b', b);
    btn.setAttribute('data-active', 'true');
    btn.addEventListener('click', ()=>{
      const on = btn.getAttribute('data-active') === 'true';
      btn.setAttribute('data-active', String(!on));
    });
    subSeg.appendChild(btn);
  }
  $('#subAll').addEventListener('click', ()=> $$('#subSeg button').forEach(b=>b.setAttribute('data-active','true')));
  $('#subClear').addEventListener('click', ()=> $$('#subSeg button').forEach(b=>b.setAttribute('data-active','false')));

  // --- State ---
  let deck = [];        // current round cards
  let nextDeck = [];    // NG cards collected during round
  let idx = -1;         // current index in deck
  let flipped = false;  // reveal state
  let stats = {ok:0, ng:0, seen:0, total:0};
  let started = false;

  const els = {
    card: $('#card'),
    ok: $('#okBtn'), ng: $('#ngBtn'), reveal: $('#revealBtn'),
    redo: $('#redoBtn'),
    count: $('#count'), okC: $('#okC'), ngC: $('#ngC'), bar: $('#bar')
  };

  function buildAddPool(){
    const actives = $$('#addSeg button').filter(b=>b.getAttribute('data-active')==='true').map(b=>+b.dataset.a);
    let pool = [];
    for(const a of actives){
      for(let b=1; b<=9; b++){
        if($('#carryB').checked && a+b < 10) continue; // くり上がり：答えが2桁のみ
        pool.push({op:'+', a, b});
      }
    }
    return pool;
  }

  // ひき算のルールは既存アプリと同様
  function buildSubPool(){
    const selectedB = $$('#subSeg button').filter(b=>b.getAttribute('data-active')==='true').map(b=>+b.dataset.b);
    let pool = [];
    for(const b of selectedB){
      for(let A=b; A<=b+9; A++){
        if(A===b) continue;           // 0は除外
        if(A-b>=10) continue;         // 2けたの答えは除外
        if($('#borrowB').checked && A<10) continue; // くり下がりONなら被減数は2けたのみ
        pool.push({op:'-', A, b});
      }
    }
    return pool;
  }

  function buildPool(){
    const useAdd = $('#useAdd').checked;
    const useSub = $('#useSub').checked;
    let pool = [];
    if(useAdd) pool = pool.concat(buildAddPool());
    if(useSub) pool = pool.concat(buildSubPool());
    if(pool.length===0) return pool;
    if($('#shuffleB').checked) pool = shuffle(pool);
    return pool;
  }

  function start(){
    deck = buildPool();
    if(deck.length === 0){ alert('出題範囲を選んでください（少なくともたし算かひき算のどちらか）'); return; }
    nextDeck = [];
    idx = -1; flipped = false; started = true; stats = {ok:0, ng:0, seen:0, total:deck.length};
    els.redo.disabled = false;
    resetTimer();
    startTimer();
    step();
  }

  function step(){
    flipped = false;
    idx++;
    if(idx >= deck.length){
      // round finished -> NG only
      if(nextDeck.length === 0){
        showDone();
        return;
      }
      deck = $('#shuffleB').checked ? shuffle(nextDeck) : nextDeck.slice();
      nextDeck = [];
      idx = 0;
    }
    const c = deck[idx];
    if(c.op === '+'){
      els.card.textContent = `${c.a} + ${c.b} = ?`;
    }else{
      els.card.textContent = `${c.A} − ${c.b} = ?`;
    }
    enableDuringQuestion();
    updateUI();
  }

  function showDone(){
    els.card.textContent = `すべてOK！（${stats.ok}問 正解）`;
    disableAnswering();
    stopTimer();
    updateUI(true);
  }

  function enableDuringQuestion(){
    els.reveal.disabled = false; els.ok.disabled = true; els.ng.disabled = true;
  }
  function enableAfterReveal(){
    els.ok.disabled = false; els.ng.disabled = false;
  }
  function disableAnswering(){
    els.reveal.disabled = true; els.ok.disabled = true; els.ng.disabled = true;
  }

  // --- Actions ---
  $('#startBtn').addEventListener('click', start);
  $('#revealBtn').addEventListener('click', ()=>{
    if(!started) return;
    const c = deck[idx];
    if(c.op === '+'){
      els.card.textContent = `${c.a} + ${c.b} = ${c.a + c.b}`;
    }else{
      els.card.textContent = `${c.A} − ${c.b} = ${c.A - c.b}`;
    }
    flipped = true; enableAfterReveal();
  });
  $('#okBtn').addEventListener('click', ()=> decide(true));
  $('#ngBtn').addEventListener('click', ()=> decide(false));

  function decide(isOk){
    if(!started || !flipped) return; // must reveal first
    const card = deck[idx];
    stats.seen++;
    if(isOk){ stats.ok++; } else { stats.ng++; nextDeck.push(card); }
    updateUI();
    step();
  }

  // Reset all
  $('#redoBtn').addEventListener('click', start);

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.target.closest('input,textarea')) return;
    if(e.code === 'Space'){ e.preventDefault(); if(!els.reveal.disabled) $('#revealBtn').click(); return; }
    if(e.key.toLowerCase()==='o'){ if(!els.ok.disabled) $('#okBtn').click(); }
    if(e.key.toLowerCase()==='x'){ if(!els.ng.disabled) $('#ngBtn').click(); }
  });

  // --- UI ---
  function updateUI(isDone=false){
    $('#count').textContent = `${Math.min(stats.seen+1, stats.total)} / ${stats.total}`;
    $('#okC').textContent = stats.ok; $('#ngC').textContent = stats.ng;
    const ratio = stats.total? Math.min(100, Math.round((stats.seen/stats.total)*100)) : 0;
    $('#bar').style.width = (isDone? '100' : String(ratio)) + '%';
  }
})();
</script>
</body>
</html>
